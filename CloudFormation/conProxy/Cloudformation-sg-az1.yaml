AWSTemplateFormatVersion: "2010-09-09"
Description: "Stack para la creación de Security Groups"

Resources:
  securityGroupProxyAZ1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security Group para el Proxy Inverso"
      VpcId: !ImportValue equipo3-VPC-ID
      SecurityGroupIngress:
        # Tráfico HTTP y HTTPS desde Internet hacia el Proxy Inverso
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0  # HTTP
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0  # HTTPS
        
        # Acceso SSH al Proxy Inverso desde Internet
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0  # SSH
        
        # Tráfico XMPP desde clientes e interservidores hacia el Proxy Inverso
        - IpProtocol: tcp
          FromPort: 5222
          ToPort: 5222
          CidrIp: 0.0.0.0/0  # XMPP cliente
        - IpProtocol: tcp
          FromPort: 5269
          ToPort: 5269
          CidrIp: 0.0.0.0/0  # XMPP interservidores
        
        # Administración de Ejabberd a través del Proxy Inverso
        - IpProtocol: tcp
          FromPort: 5280
          ToPort: 5280
          CidrIp: 0.0.0.0/0  # Administración HTTP
        - IpProtocol: tcp
          FromPort: 5281
          ToPort: 5281
          CidrIp: 0.0.0.0/0  # Administración HTTPS
        
        # WebSockets para comunicación en tiempo real
        - IpProtocol: tcp
          FromPort: 5443
          ToPort: 5443
          CidrIp: 0.0.0.0/0  # WebSockets HTTPS para XMPP
      Tags:
        - Key: Name
          Value: "equipo3-sg-proxy"

SecurityGroupEjabberd:
  Type: AWS::EC2::SecurityGroup
  Properties:
    GroupDescription: "Security Group para Ejabberd"
    VpcId: !ImportValue equipo3-VPC-ID
    SecurityGroupIngress:
      # Redirección de tráfico desde el Proxy Inverso hacia Ejabberd
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # HTTP
      - IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # SSH
      - IpProtocol: tcp
        FromPort: 5222
        ToPort: 5222
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # XMPP cliente
      - IpProtocol: tcp
        FromPort: 5269
        ToPort: 5269
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # XMPP interservidores
      - IpProtocol: tcp
        FromPort: 5280
        ToPort: 5280
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # Administración HTTP
      - IpProtocol: tcp
        FromPort: 5281
        ToPort: 5281
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # Administración HTTPS
      - IpProtocol: tcp
        FromPort: 5443
        ToPort: 5443
        SourceSecurityGroupId: !Ref SecurityGroupProxyAZ1  # WebSockets HTTPS para XMPP

      # Permitir comunicación interna entre los nodos del clúster de Ejabberd
      - IpProtocol: tcp
        FromPort: 5222
        ToPort: 5222
        SourceSecurityGroupId: !Ref SecurityGroupEjabberd  # XMPP entre nodos Ejabberd
      - IpProtocol: tcp
        FromPort: 5269
        ToPort: 5269
        SourceSecurityGroupId: !Ref SecurityGroupEjabberd  # Comunicación interservidores
      - IpProtocol: tcp
        FromPort: 5280
        ToPort: 5280
        SourceSecurityGroupId: !Ref SecurityGroupEjabberd  # Administración HTTP interna

      # Permitir acceso desde HAProxy para balanceo de carga
      - IpProtocol: tcp
        FromPort: 5222
        ToPort: 5222
        SourceSecurityGroupId: !ImportValue equipo3-SG-HAProxy-ID  # Permitir tráfico desde HAProxy

    SecurityGroupEgress:
      # Permitir tráfico saliente desde Ejabberd hacia Internet (a través del NAT Gateway)
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0

    Tags:
      - Key: Name
        Value: "equipo3-sg-ejabberd"


SecurityGroupPostgreSQL:
  Type: AWS::EC2::SecurityGroup
  Properties:
    GroupDescription: "Security Group para la Base de Datos PostgreSQL"
    VpcId: !ImportValue equipo3-VPC-ID
    SecurityGroupIngress:
      # Permitir tráfico entre los nodos del clúster de PostgreSQL para replicación
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId: !Ref SecurityGroupPostgreSQL  # Comunicación entre nodos PostgreSQL

      # Permitir acceso desde Ejabberd hacia PostgreSQL
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId: !Ref SecurityGroupEjabberd  # Acceso desde Ejabberd

      # Permitir acceso desde HAProxy para balanceo de carga
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId: !ImportValue equipo3-SG-HAProxy-ID  # Permitir tráfico desde HAProxy

    SecurityGroupEgress:
      # Permitir tráfico saliente desde PostgreSQL
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0

    Tags:
      - Key: Name
        Value: "equipo3-sg-postgresql"


Outputs:
  ecurityGroupProxyAZ1Id:
    Description: "ID del Security Group del Proxy"
    Value: !Ref ecurityGroupProxyAZ1
    Export:
      Name: "equipo3-SG-Proxy-AZ1-ID"

  SecurityGroupEjabberdId:
    Description: "ID del Security Group de Ejabberd"
    Value: !Ref SecurityGroupEjabberd
    Export:
      Name: "equipo3-SG-Ejabberd-ID"

  SecurityGroupPostgreSQLId:
    Description: "ID del Security Group de PostgreSQL"
    Value: !Ref SecurityGroupPostgreSQL
    Export:
      Name: "equipo3-SG-PostgreSQL-ID"
